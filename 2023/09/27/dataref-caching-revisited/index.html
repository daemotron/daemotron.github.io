<!doctype html><html itemscope itemtype=https://schema.org/WebPage class=no-js lang=en><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=siteBaseUrl content="https://www.my-universe.com/"><meta name=author content="daemotron"><meta name=description content="Mens Insana in Corpore Ignavo"><meta name=keywords content="blog,developer,personal"><meta name=generator content="Hugo 0.142.0"><title>Dataref Caching Revisited | My Universe
</title><meta itemprop=name content="Dataref Caching Revisited"><meta itemprop=description content="Dataref Caching Revisited - Mens Insana in Corpore Ignavo"><meta property="og:site_name" content="My Universe"><meta property="og:url" content="https://www.my-universe.com/2023/09/27/dataref-caching-revisited/"><meta property="og:site_name" content="My Universe"><meta property="og:title" content="Dataref Caching Revisited"><meta property="og:description" content="Earlier this year I wrote about caching datarefs. Back then we only looked at caching single datarefs, which quickly leads to bloated code once applied in a wider context. So here we are again, taking a closer look at caching many datarefs efficiently.
What About Trees “Are we going to leave those poor little Datarefs here in this horrid, dark, dank, tree-infested — I mean… charming, quite charming, forest?”
— unknown dwarf coder"><meta property="og:locale" content="en_gb"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-09-27T00:00:00+00:00"><meta property="article:modified_time" content="2023-09-27T00:00:00+00:00"><meta property="article:tag" content="X-Plane"><meta property="article:tag" content="Development"><meta property="article:tag" content="C/C++"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><script src=/modernizr-simple.js></script><link rel=canonical href=https://www.my-universe.com/2023/09/27/dataref-caching-revisited/><link rel=stylesheet href=https://www.my-universe.com/theme.css></head><body class=bilberry-hugo-theme><nav><div class=container><ul class=topnav><li><a href=https://www.my-universe.com/page/about/>About</a></li><li><a href=https://www.my-universe.com/page/legal/>Legal</a></li></ul></div></nav><header><div class=container><div class=logo><a href=/ class=logo><img src=/img/avataaars.png alt>
<span class=overlay><i class="fa fa-home"></i></span></a></div><div class=titles><h3 class=title><a href=/>My Universe</a></h3><span class=subtitle>Mens Insana in Corpore Ignavo</span></div><div class=toggler><i class="fa fa-bars" aria-hidden=true></i></div></div></header><div class="main container"><div class="article-wrapper u-cf single"><a class=bubble href=https://www.my-universe.com/2023/09/27/dataref-caching-revisited/><i class="fas fa-fw fa-pencil-alt"></i></a><article class="default article"><div class=content><h1 class=article-title><a href=https://www.my-universe.com/2023/09/27/dataref-caching-revisited/>Dataref Caching Revisited</a></h1><div class=meta><span class="date moment">2023-09-27</span>
<span class=categories><a href=https://www.my-universe.com/categories/x-plane/>X-Plane</a></span></div><p>Earlier this year I wrote about <a href=/2023/04/20/cache-your-datarefs/>caching datarefs</a>. Back then we only looked at caching single datarefs, which quickly leads to bloated code once applied in a wider context. So here we are again, taking a closer look at caching <em>many</em> datarefs efficiently.</p><h4 id=what-about-trees>What About Trees</h4><blockquote><p>&ldquo;Are we going to leave those poor little Datarefs here in this horrid, dark, dank, tree-infested &mdash; I mean&mldr; charming, quite charming, forest?&rdquo;</p><p>&mdash; unknown dwarf coder</p></blockquote><p>A lot of code (real and sample code alike) out there uses trees for caching datarefs, typically <a href=https://en.wikipedia.org/wiki/AVL_tree>AVL trees</a>. The idea behind this approach: searching an AVL tree is much faster than searching a linear data structure (aka list). Let&rsquo;s break this down a bit:</p><p>&ldquo;Searching&rdquo; means going through the elements of a data structure, and comparing the elements to a search term. When talking about datarefs, we&rsquo;re usually talking about their identifier, which is a string (e. g. <code>"sim/flightmodel/weight/m_fixed"</code>). String comparisons happen to be expensive operations &mdash; <a href=https://developer.x-plane.com/sdk/XPLMDataAccess/>X-Plane&rsquo;s SDK documentation</a> explicitly warns about this:</p><blockquote><p>The task of looking up a data reference is relatively expensive; look up your data references once based on the verbose path strings, and save the opaque data reference value for the duration of your plugin’s operation. Reading and writing data references is relatively fast (the cost is equivalent to two function calls through function pointers).</p></blockquote><p>So what do we gain by caching our datarefs in a structure which forces the same, expensive lookup comparison on us? Exactly, nothing. This is why I strongly recommend to not organize a dataref cache by their string identifiers.</p><h4 id=searching-or-finding>Searching or Finding?</h4><blockquote><p>One thing to rule them all,<br>one thing to find them,<br>One thing to bring them all,<br>and in the structure bind them;<br>In the Plugin of X-Plane where the FPS dwell.</p></blockquote><p>If we want to avoid string comparisons, what do we do then instead? Numeric comparisons are much faster, can we use them instead? A good question, but let me ask you back &mdash; why did we want strings in the first place? The answer is pretty simple: strings are human-readable, so using the string identifier of a dataref makes our code more readable &mdash; for humans. Thinking about this, isn&rsquo;t the primary purpose of code that of being interpreted (i.e. executed) by a computer? Sure it is, but code maintainability is a (in this case competing) objective we shouldn&rsquo;t neglect.</p><p>As a compromise, is there something that is as human-readible as a string, and as computing-friendly as an integer? In fact, there is &mdash; let&rsquo;s dig up the good, old <code>enum</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#define DATA_DREF_COUNT_MAX 4
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>enum</span> dref_ref_n {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    SIM_AIRCRAFT_WEIGHT_ACF_M_EMPTY,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    SIM_FLIGHTMODEL_WEIGHT_M_FIXED,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    SIM_FLIGHTMODEL_WEIGHT_M_FUEL,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    SIM_TEST_TEST_FLOAT
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>} <span style=color:#8be9fd>dref_ref_t</span>;
</span></span></code></pre></div><p>This way, the cache for our datarefs could be a simple array:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdbool.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;XPLMDataAccess.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>static</span> XPLMDataRef Drefs[DATA_DREF_COUNT_MAX];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>dref_init</span>(<span style=color:#8be9fd>dref_ref_t</span> ref, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>id)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span>    Drefs[ref] <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>XPLMFindDataRef</span>(id);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>    <span style=color:#ff79c6>if</span> (Drefs[ref] <span style=color:#ff79c6>==</span> <span style=color:#8be9fd;font-style:italic>NULL</span> <span style=color:#ff79c6>||</span> <span style=color:#ff79c6>!</span><span style=color:#50fa7b>XPLMIsDataRefGood</span>(Drefs[ref]))
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>        <span style=color:#50fa7b>log_error</span>(<span style=color:#f1fa8c>&#34;Failed to initialize dataref %s&#34;</span>, id);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>        <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>false</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span><span style=color:#8be9fd>bool</span> <span style=color:#50fa7b>drefs_init</span>(<span style=color:#8be9fd>void</span>)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>    <span style=color:#8be9fd>bool</span> flag <span style=color:#ff79c6>=</span> <span style=color:#8be9fd;font-style:italic>true</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>    flag <span style=color:#ff79c6>=</span> flag <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>dref_init</span>(SIM_AIRCRAFT_WEIGHT_ACF_M_EMPTY, <span style=color:#f1fa8c>&#34;sim/aircraft/weight/acf_m_empty&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>    flag <span style=color:#ff79c6>=</span> flag <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>dref_init</span>(SIM_FLIGHTMODEL_WEIGHT_M_FIXED, <span style=color:#f1fa8c>&#34;sim/flightmodel/weight/m_fixed&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>    flag <span style=color:#ff79c6>=</span> flag <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>dref_init</span>(SIM_FLIGHTMODEL_WEIGHT_M_FUEL, <span style=color:#f1fa8c>&#34;sim/flightmodel/weight/m_fuel&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>    flag <span style=color:#ff79c6>=</span> flag <span style=color:#ff79c6>&amp;&amp;</span> <span style=color:#50fa7b>dref_init</span>(SIM_TEST_TEST_FLOAT, <span style=color:#f1fa8c>&#34;sim/test/test_float&#34;</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>    <span style=color:#ff79c6>return</span> flag;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>}
</span></span></code></pre></div><p>And in our code, we address datarefs by their <code>dref_ref_t</code> enum label &mdash; perhaps not as nice as the string identifiers, but still human readable and way faster for the computer to handle. A getter function for float values could e.g. look like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;assert.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#8be9fd>float</span> <span style=color:#50fa7b>dref_get_value_f</span>(<span style=color:#8be9fd>dref_ref_t</span> ref)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#50fa7b>assert</span>(ref <span style=color:#ff79c6>&lt;</span> DATA_DREF_COUNT_MAX);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    <span style=color:#ff79c6>return</span> <span style=color:#50fa7b>XPLMGetDataf</span>(Drefs[ref]);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>}
</span></span></code></pre></div><p>So if we wanted to retrieve the emtpy aircraft weight somewhere in our plugin code, we&rsquo;d do something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>float</span> empty_weight <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>dref_get_value_f</span>(SIM_AIRCRAFT_WEIGHT_ACF_M_EMPTY);
</span></span></code></pre></div><h4 id=tldr>TL;DR</h4><p>Organizing a dataref cache by string identifiers is a horrid idea. Using an AVL tree somewhat improves the performance over a linear list, but the basic idea remains horrid &mdash; the cache won&rsquo;t be faster than <code>XPLMFindDataRef</code>, making the cache pretty pointless. Use an array with numeric indices instead, which allows for (almost) immediate dereferencing without expensive string comparisons and data structure traversing. To make your code more readable, use an <code>enum</code> to name to those numeric indices in a human-readable way.</p></div><div class=footer><div class=tags><i class="fa fa-tags"></i><div class=links><a href=https://www.my-universe.com/tags/x-plane/>X-Plane</a>
<a href=https://www.my-universe.com/tags/development/>Development</a>
<a href=https://www.my-universe.com/tags/c/c++/>C/C++</a></div></div></div></article></div><div id=comments-container></div></div><footer><div class=container><div class=recent-posts><strong>Latest posts</strong><ul><li><a href=https://www.my-universe.com/2024/04/06/configuration-to-go/>Configuration to Go</a></li><li><a href=https://www.my-universe.com/2023/10/31/elegant-python-exceptions/>Elegant Python Exceptions</a></li><li><a href=https://www.my-universe.com/2023/09/27/dataref-caching-revisited/>Dataref Caching Revisited</a></li><li><a href=https://www.my-universe.com/2023/09/23/configuration-file-with-xppl/>Configuration File with XPPL</a></li><li><a href=https://www.my-universe.com/2023/09/22/introducing-xppl/>Introducing XPPL</a></li><li><a href=https://www.my-universe.com/2023/04/20/cache-your-datarefs/>Cache Your Datarefs</a></li><li><a href=https://www.my-universe.com/2023/01/14/talk-to-the-log/>Talk to the Log</a></li></ul></div><div class=categories><a href=https://www.my-universe.com/categories/><strong>Categories</strong></a><ul><li><a href=https://www.my-universe.com/categories/x-plane/>X-Plane (3)</a></li><li><a href=https://www.my-universe.com/categories/website/>Website (2)</a></li><li><a href=https://www.my-universe.com/categories/go/>Go (1)</a></li><li><a href=https://www.my-universe.com/categories/python/>Python (1)</a></li></ul></div><div class=right><div class=external-profiles><strong>Social media</strong>
<a href=https://github.com/daemotron target=_blank rel><em class="fab fa-github"></em></a>
<a href=https://gitlab.com/daemotron target=_blank rel><em class="fab fa-gitlab"></em></a>
<a href=https://stackoverflow.com/users/5217009/daemotron target=_blank rel=me><em class="fab fa-stack-overflow"></em></a>
<a href=https://www.linkedin.com/in/jescofreund target=_blank rel><em class="fab fa-linkedin"></em></a>
<a href=/index.xml target=_blank rel><em class="fas fa-rss"></em></a></div><div class=archive><a href=https://www.my-universe.com/archive/><strong>Archive</strong></a></div></div></div></footer><div class=credits><div class=container><div class=copyright><a href=https://www.my-universe.com/ target=_blank>&copy;
2017 - 2025
My Universe</a></div><div class=author><a href=https://gohugo.io/ target=_blank>Powered by Hugo & Bilberry Hugo Theme</a></div></div></div><script src=https://www.my-universe.com/theme.js></script></body></html>