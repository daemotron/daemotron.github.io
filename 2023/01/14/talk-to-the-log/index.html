<!doctype html><html lang=en><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><title>Talk to the Log | My Universe</title><meta name=author content="daemotron"><meta name=description content="Making an X-Plane plugin &ldquo;talk&rdquo; to us is one of the boilerplate tasks when setting up a new plugin project. X-Plane has its own log file, log.txt, which is found in X-Plane&rsquo;s root folder. The file gets reset every time X-Plane starts, so there&rsquo;s no need to rotate or trim it from time to time. As a plugin author, we have the choice to either write our own log file, or to jump on X-Plane&rsquo;s bandwagon and use its logging system for our purposes."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Talk to the Log"><meta name=twitter:description content="Making an X-Plane plugin &ldquo;talk&rdquo; to us is one of the boilerplate tasks when setting up a new plugin project. X-Plane has its own log file, log.txt, which is found in X-Plane&rsquo;s root folder. The file gets reset every time X-Plane starts, so there&rsquo;s no need to rotate or trim it from time to time. As a plugin author, we have the choice to either write our own log file, or to jump on X-Plane&rsquo;s bandwagon and use its logging system for our purposes."><meta property="og:title" content="Talk to the Log"><meta property="og:description" content="Making an X-Plane plugin &ldquo;talk&rdquo; to us is one of the boilerplate tasks when setting up a new plugin project. X-Plane has its own log file, log.txt, which is found in X-Plane&rsquo;s root folder. The file gets reset every time X-Plane starts, so there&rsquo;s no need to rotate or trim it from time to time. As a plugin author, we have the choice to either write our own log file, or to jump on X-Plane&rsquo;s bandwagon and use its logging system for our purposes."><meta property="og:type" content="article"><meta property="og:url" content="https://daemotron.github.io/2023/01/14/talk-to-the-log/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-14T19:51:48+01:00"><meta property="article:modified_time" content="2023-01-14T19:51:48+01:00"><link rel=stylesheet href=/css/bootstrap.min.css crossorigin=anonymous><link href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.2.1/css/all.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/sass/main.css><link rel=stylesheet href=/zoomjs/zoom.min.css><script src=/js/lazysizes.min.js></script>
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><nav class="navbar navbar-default navbar-custom navbar-fixed-top invert"><div class=container-fluid><div class="navbar-header page-scroll"><button type=button class=navbar-toggle>
<span class=sr-only>Toggle navigation</span>
<span class=icon-bar></span>
<span class=icon-bar></span>
<span class=icon-bar></span></button>
<a class=navbar-brand href=https://daemotron.github.io/>My Universe</a></div><div id=huxblog_navbar><div class=navbar-collapse><ul class="nav navbar-nav navbar-right"><li><a href=/ title=Home>Home</a></li><li><a href=/archive/ title=Archive>Archive</a></li><li><a href=/about/ title=About>About</a></li><li><a href=https://github.com/daemotron/daemotron.github.io/ title=Github>Github</a></li><li class=search-icon><a href=javascript:void(0)><i class="fa fa-search"></i></a></li></ul></div></div></div></nav><script>var $body=document.body,$toggle=document.querySelector(".navbar-toggle"),$navbar=document.querySelector("#huxblog_navbar"),$collapse=document.querySelector(".navbar-collapse"),__HuxNav__={close:function(){$navbar.className=" ",setTimeout(function(){$navbar.className.indexOf("in")<0&&($collapse.style.height="0px")},400)},open:function(){$collapse.style.height="auto",$navbar.className+=" in"}};$toggle.addEventListener("click",function(){$navbar.className.indexOf("in")>0?__HuxNav__.close():__HuxNav__.open()}),document.addEventListener("click",function(e){if(e.target==$toggle)return;if(e.target.className=="icon-bar")return;__HuxNav__.close()})</script><div class=search-page><div class=search-icon-close-container><span class=search-icon-close><i class="fa fa-chevron-down"></i></span></div><div class="search-main container"><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><form></form><input type=text id=search-input placeholder="$ grep..."></form><div id=search-results class=mini-post-list></div></div></div></div></div><style type=text/css>header.intro-header{position:relative;background-image:url('')}</style><header class="intro-header style-text"><div class=header-mask></div><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><div class=post-heading><div class=tags><a class=tag href=/tags/x-plane/ title=x-plane>x-plane</a>
<a class=tag href=/tags/development/ title=development>development</a>
<a class=tag href=/tags/c/c++/ title=c/c++>c/c++</a></div><h1>Talk to the Log</h1><h2 class=subheading></h2><span class=meta>Posted by daemotron
on Sat, Jan 14, 2023</span></div></div></div></div></header><article><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
post-container"><p>Making an <a href=https://www.x-plane.com/ target=_blank>X-Plane</a> plugin &ldquo;talk&rdquo; to us is one of the boilerplate tasks when setting up a new plugin project. X-Plane has its own log file, <code>log.txt</code>, which is found in X-Plane&rsquo;s root folder. The file gets reset every time X-Plane starts, so there&rsquo;s no need to rotate or trim it from time to time. As a plugin author, we have the choice to either write our own log file, or to jump on X-Plane&rsquo;s bandwagon and use its logging system for our purposes. While I can see the benefits of having a dedicated logfile for a plugin, personally I prefer to use X-Plane&rsquo;s built in logging mechanism &ndash; there are technical reasons, but mostly it&rsquo;s a comfort and usability decision: most X-Plane users will immediately think of the central <code>log.txt</code> file when a developer asks them to provide their log file (e.g. when reporting an issue).</p><p>So let&rsquo;s take a look at the <a href=https://developer.x-plane.com/sdk/XPLMUtilities/ target=_blank>XPLMUtilities</a> API provided by the X-Plane SDK. It provides a function called <a href=https://developer.x-plane.com/sdk/XPLMDebugString/ target=_blank>XPLMDebugString</a>, which provides a pretty simple interface to X-Plane&rsquo;s logging mechanism:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;XPLMUtilities.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>XPLM_API <span style=color:#8be9fd>void</span> <span style=color:#50fa7b>XPLMDebugString</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>message);
</span></span></code></pre></div><p>What this function does is pretty straight forward - it appends the string <code>message</code> to the <code>log.txt</code> log file. It doesn&rsquo;t add fancy timestamps, it doesn&rsquo;t care for log levels and verbosity, and it doesn&rsquo;t process format strings and arguments. In consequence, if we need all that (and normally we do), we&rsquo;ll have to implement it ourselves.</p><p>For this purpose, let&rsquo;s create two files called <code>log.h</code> and <code>log.c</code> within our plugin&rsquo;s source code directory (if you followed <a href=/2023/01/04/x-plane-plugin-boilerplate/ target=_blank>my earlier post on this subject</a>, the source files would go into the <code>src</code> directory). Let&rsquo;s start with the log API we&rsquo;d like to have available in the other modules of our plugin. I prefer to have a set of four logging functions, so let&rsquo;s define them in <code>log.h</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#ifndef _DAEMOPLUG_LOG_H_
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#define _DAEMOPLUG_LOG_H_
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6>#ifdef __cplusplus
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6></span><span style=color:#ff79c6>extern</span> <span style=color:#f1fa8c>&#34;C&#34;</span> {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdarg.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span><span style=color:#ff79c6>#define LOG_BUFFER_SIZE 256
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span><span style=color:#ff79c6>typedef</span> <span style=color:#ff79c6>enum</span> log_level
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span>    Debug<span style=color:#ff79c6>=</span><span style=color:#bd93f9>0</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>    Info<span style=color:#ff79c6>=</span><span style=color:#bd93f9>1</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    Warn<span style=color:#ff79c6>=</span><span style=color:#bd93f9>2</span>,
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    Error<span style=color:#ff79c6>=</span><span style=color:#bd93f9>4</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>} <span style=color:#8be9fd>log_level_t</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>log_debug</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>, ...);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>log_info</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>, ...);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>log_warn</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>, ...);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>log_error</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>, ...);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span><span style=color:#ff79c6>#ifdef	__cplusplus
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span><span style=color:#ff79c6></span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span><span style=color:#ff79c6>#endif
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span><span style=color:#ff79c6>#endif </span><span style=color:#6272a4>/* _DAEMOPLUG_LOG_H_ */</span><span style=color:#ff79c6>
</span></span></span></code></pre></div><p>These function prototypes all expect a string, followed by arbitrary arguments. Basically the same syntax you&rsquo;d use with the <code>printf()</code> family of functions. Now, following the DRY (&ldquo;don&rsquo;t repeat yourself&rdquo;) principle, it doesn&rsquo;t make sense to implement the full logging functionality four times. Instead, we&rsquo;re going to implement a single logging function, which will do the log processing on behalf of the logging API functions. The function as I implemented it in <code>log.c</code> looks like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdarg.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;stdio.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;string.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;XPLMDataAccess.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&lt;XPLMUtilities.h&gt;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8</span><span><span style=color:#ff79c6>#include</span> <span style=color:#ff79c6>&#34;log.h&#34;</span><span style=color:#ff79c6>
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9</span><span><span style=color:#ff79c6></span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11</span><span><span style=color:#8be9fd>log_level_t</span> MinLogLevel <span style=color:#ff79c6>=</span> Debug;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14</span><span><span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span><span style=color:#50fa7b>log_level_string</span>(<span style=color:#8be9fd>log_level_t</span> level)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16</span><span>    <span style=color:#ff79c6>switch</span> (level)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18</span><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>Debug</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;DEBUG&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20</span><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22</span><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>Info</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34; INFO&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24</span><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26</span><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>Warn</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34; WARN&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28</span><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30</span><span>        <span style=color:#ff79c6>case</span> <span style=color:#8be9fd;font-style:italic>Error</span>:
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;ERROR&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32</span><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33</span><span>        
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34</span><span>        <span style=color:#ff79c6>default</span><span style=color:#ff79c6>:</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35</span><span>            <span style=color:#ff79c6>return</span> <span style=color:#f1fa8c>&#34;INVAL&#34;</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36</span><span>            <span style=color:#ff79c6>break</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38</span><span>}
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>log_msg_v</span>(<span style=color:#8be9fd>log_level_t</span> level, <span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>message, va_list args)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43</span><span>    <span style=color:#6272a4>/* don&#39;t log anything below the set log level */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44</span><span>    <span style=color:#ff79c6>if</span> (level <span style=color:#ff79c6>&lt;</span> MinLogLevel)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45</span><span>    {
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46</span><span>        <span style=color:#ff79c6>return</span>;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47</span><span>    }
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49</span><span>    <span style=color:#6272a4>/* retrieve data for the time stamp (X-Plane convention) */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50</span><span>    <span style=color:#8be9fd>int</span> hrs, min;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51</span><span>    <span style=color:#8be9fd>float</span> sec, net_time <span style=color:#ff79c6>=</span> <span style=color:#50fa7b>XPLMGetDataf</span>(<span style=color:#50fa7b>XPLMFindDataRef</span>(<span style=color:#f1fa8c>&#34;sim/network/misc/network_time_sec&#34;</span>));
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52</span><span>	hrs <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>int</span>)(net_time <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>3600.0f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53</span><span>	min <span style=color:#ff79c6>=</span> (<span style=color:#8be9fd>int</span>)(net_time <span style=color:#ff79c6>/</span> <span style=color:#bd93f9>60.0f</span>) <span style=color:#ff79c6>-</span> (<span style=color:#8be9fd>int</span>)(hrs <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>60.0f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54</span><span>	sec <span style=color:#ff79c6>=</span> net_time <span style=color:#ff79c6>-</span> (hrs <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>3600.0f</span>) <span style=color:#ff79c6>-</span> (min <span style=color:#ff79c6>*</span> <span style=color:#bd93f9>60.0f</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55</span><span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56</span><span>    <span style=color:#6272a4>/* create the message by rolling in eventual arguments */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57</span><span>    <span style=color:#8be9fd>char</span> msg_buffer[LOG_BUFFER_SIZE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58</span><span>    <span style=color:#50fa7b>memset</span>(msg_buffer, <span style=color:#f1fa8c>&#39;\0&#39;</span>, LOG_BUFFER_SIZE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>1</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59</span><span>    <span style=color:#50fa7b>vsnprintf</span>(msg_buffer, LOG_BUFFER_SIZE, message, args);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61</span><span>    <span style=color:#6272a4>/* prepare the log buffer and send it to log.txt */</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62</span><span>    <span style=color:#8be9fd>char</span> log_buffer[LOG_BUFFER_SIZE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>64</span>];
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63</span><span>    <span style=color:#50fa7b>memset</span>(log_buffer, <span style=color:#f1fa8c>&#39;\0&#39;</span>, LOG_BUFFER_SIZE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>64</span>);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64</span><span>	<span style=color:#50fa7b>snprintf</span>(log_buffer, LOG_BUFFER_SIZE <span style=color:#ff79c6>+</span> <span style=color:#bd93f9>64</span>, <span style=color:#f1fa8c>&#34;%d:%02d:%06.3f [DAEMOPLUG]: %s: %s</span><span style=color:#f1fa8c>\n</span><span style=color:#f1fa8c>&#34;</span>, hrs, min, sec, <span style=color:#50fa7b>log_level_string</span>(level), msg_buffer);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65</span><span>    <span style=color:#50fa7b>XPLMDebugString</span>(log_buffer);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66</span><span>}
</span></span></code></pre></div><p>I created a global variable <code>MinLogLevel</code> instead of defining it as a constant in <code>log.h</code> for a simple reason &mdash; this way I can modify the log level at runtime, e.g. through a configuration file when initializing the plugin or similar. One of the rare cases where a global variable makes sense, given you only ever write to it in a dedicated place (e.g. define a function <code>log_level_set()</code> and make it publicly available).</p><p><code>log_level_string()</code> is only an auxiliary function, providing a 6 bytes long string containing the log level label (5 characters plus string terminator). The actual work is done in <code>log_msg_v()</code> (I append <code>_v</code> to functions which require a <code>va_list</code> argument, but we&rsquo;ll get to that in a moment). In a first step, we check if the log level of the message submitted is actually high enough to go through &mdash; otherwise we can already stop here. As already mentioned, we have to take care of providing our own time stamp if we want one (useful to see the timing of certain events in the log, so I highly recommend it). Using X-Plane&rsquo;s <code>sim/network/misc/network_time_sec</code> data ref as time source keeps our timestamps in sync with those used by X-Plane internally. Calculating hours, minutes and seconds is just a bit of simple maths.</p><p>The third step is to actually assemble the message. So far the message consists of a format string (<code>message</code> in our example), and eventual further parameters stored in the <code>args</code> parameter (strictly speaking <code>args</code> is just a pointer to the data structure holding those parameters, ). <code>stdio.h</code> provides a variant of the <code>s(n)printf</code> function, taking a single <code>va_list</code> pointer instead of individual arguments after the format string. Wherever possible, I try using the <code>n</code> versions of these functions to have a solid protection from buffer overflows and subsequent segmentation faults.</p><p>Finally all information can be merged into the complete message &mdash; time stamp, plugin identifier, log level and the message we just assembled, and the completed buffer gets handed over to X-Plane&rsquo;s <code>XPLMDebugString()</code> function, which takes care that the message actually gets written into the <code>log.txt</code> log file, even in case of a crash (at least if the crash occurs after <code>XPLMDebugString()</code> has been called).</p><p>What remains now is the public interface &mdash; as an example, I&rsquo;m going to show here just the <code>log_debug()</code> function. The other three look almost identical:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#8be9fd>void</span> <span style=color:#50fa7b>log_debug</span>(<span style=color:#ff79c6>const</span> <span style=color:#8be9fd>char</span> <span style=color:#ff79c6>*</span>message, ...)
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>{
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>    va_list args;
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>    
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>    <span style=color:#50fa7b>va_start</span>(args, message);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>    <span style=color:#50fa7b>log_msg_v</span>(Debug, message, args);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>    <span style=color:#50fa7b>va_end</span>(args);
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>}
</span></span></code></pre></div><p>As usual, there are many more possibilities to solve the logging problem in X-Plane. However, I feel it&rsquo;s crucial to have the most simple and straight-forward interface available, so the principle of format strings and arbitrary arguments is one I would never give up &mdash; having to start fiddling with buffers the moment I just want to log an error doesn&rsquo;t seem appealing to me. Anything else IMO is a matter of taste, including the exact format of the log string.</p><hr style=visibility:hidden><ul class=pager><li class=previous><a href=/2023/01/11/cmake-linux-hack/ data-toggle=tooltip data-placement=top title="CMake Linux Hack">Previous<br><span>CMake Linux Hack</span></a></li><li class=next><a href=/2023/04/20/cache-your-datarefs/ data-toggle=tooltip data-placement=top title="Cache Your Datarefs">Next<br><span>Cache Your Datarefs</span></a></li></ul><hr style=visibility:hidden></div><div class="col-lg-8 col-lg-offset-2
col-md-10 col-md-offset-1
sidebar-container"><section><hr class="hidden-sm hidden-xs"><h5>FEATURED TAGS</h5><div class=tags><a href=/tags/blog/>blog</a>
<a href=/tags/c/c++/>c/c++</a>
<a href=/tags/cmake/>cmake</a>
<a href=/tags/development/>development</a>
<a href=/tags/django/>django</a>
<a href=/tags/git/>git</a>
<a href=/tags/github/>github</a>
<a href=/tags/hubpress/>hubpress</a>
<a href=/tags/hugo/>hugo</a>
<a href=/tags/python/>python</a>
<a href=/tags/x-plane/>x-plane</a></div></section></div></div></div></article><footer><div class=container><div class=row><div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1"><ul class="list-inline text-center"><li><a href=https://github.com/daemotron target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-github fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://linkedin.com/in/jescofreund target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-linkedin fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://gitlab.com/daemotron target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-gitlab fa-stack-1x fa-inverse"></i></span></a></li><li><a href=https://stackoverflow.com/users/5217009/daemotron target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fab fa-stack-overflow fa-stack-1x fa-inverse"></i></span></a></li><li><a href=/index.xml target=_blank><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i>
<i class="fas fa-rss fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; My Universe 2023<br>Powered by <a href=https://gohugo.io>Hugo</a></p></div></div></div></footer><script src=/js/jquery.min.js></script>
<script src=/js/bootstrap.min.js crossorigin=anonymous></script>
<script src=/js/hux-blog.min.c4ea77041cd3edbfc8b2622cd887a9a5d8760a4162d14489e36d2a3fa4c90172.js></script>
<script src=/js/simple-jekyll-search.min.js></script>
<script src=/js/search.min.53bce5da475b4d362500e5ce5dddfa22e20e1b9018777411d2020b4b839c9310.js></script>
<script src=/zoomjs/zoom.min.js></script></body></html>