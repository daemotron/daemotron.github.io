<!DOCTYPE html>
<html>
  <head>
    <title>Pythonic Distance Conversion</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    
    
    <link rel="apple-touch-icon" sizes="57x57" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-57x57.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="60x60" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-60x60.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="72x72" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-72x72.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="76x76" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-76x76.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="114x114" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-114x114.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="120x120" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-120x120.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="144x144" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-144x144.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="152x152" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-152x152.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="apple-touch-icon" sizes="180x180" href="//daemotron.github.io/themes/uno-zen/assets/img/apple-touch-icon-180x180.png?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="icon" type="image/png" href="//daemotron.github.io/themes/uno-zen/assets/img/favicon-32x32.png?v=wAAv6Wqe6l?v=1495998380823" sizes="32x32">
    <link rel="icon" type="image/png" href="//daemotron.github.io/themes/uno-zen/assets/img/favicon-194x194.png?v=wAAv6Wqe6l?v=1495998380823" sizes="194x194">
    <link rel="icon" type="image/png" href="//daemotron.github.io/themes/uno-zen/assets/img/favicon-96x96.png?v=wAAv6Wqe6l?v=1495998380823" sizes="96x96">
    <link rel="icon" type="image/png" href="//daemotron.github.io/themes/uno-zen/assets/img/android-chrome-192x192.png?v=wAAv6Wqe6l?v=1495998380823" sizes="192x192">
    <link rel="icon" type="image/png" href="//daemotron.github.io/themes/uno-zen/assets/img/favicon-16x16.png?v=wAAv6Wqe6l?v=1495998380823" sizes="16x16">
    <link rel="manifest" href="//daemotron.github.io/themes/uno-zen/assets/img/manifest.json?v=wAAv6Wqe6l?v=1495998380823">
    <link rel="shortcut icon" href="//daemotron.github.io/themes/uno-zen/assets/img/favicon.ico?v=wAAv6Wqe6l?v=1495998380823">
    <meta name="msapplication-TileColor" content="#e74c3c">
    <meta name="msapplication-TileImage" content="//daemotron.github.io/themes/uno-zen/assets/img/mstile-144x144.png?v=wAAv6Wqe6l?v=1495998380823">
    <meta name="msapplication-config" content="//daemotron.github.io/themes/uno-zen/assets/img/browserconfig.xml?v=wAAv6Wqe6l?v=1495998380823">
    <meta name="theme-color" content="#e74c3c">
    <link rel="stylesheet" type="text/css" href="//daemotron.github.io/themes/uno-zen/assets/css/uno-zen.css?v=1495998380823" />
    <link rel="canonical" href="https://daemotron.github.io/2017/05/28/Pythonic-Distance-Conversion.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="My Universe" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Pythonic Distance Conversion" />
    <meta property="og:description" content="When dealing with distances or lengths, it&amp;#8217;s a common problem to convert values between all the different units available out there. Of course, converting itself is a less than complicated simple floating point division or multiplication, depending on how values and conversion factors are stored internally. However, maintaining" />
    <meta property="og:url" content="https://daemotron.github.io/2017/05/28/Pythonic-Distance-Conversion.html" />
    <meta property="article:published_time" content="2017-05-28T00:00:00.000Z" />
    <meta property="article:tag" content="Development" />
    <meta property="article:tag" content="Python" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Pythonic Distance Conversion" />
    <meta name="twitter:description" content="When dealing with distances or lengths, it&amp;#8217;s a common problem to convert values between all the different units available out there. Of course, converting itself is a less than complicated simple floating point division or multiplication, depending on how values and conversion factors are stored internally. However, maintaining" />
    <meta name="twitter:url" content="https://daemotron.github.io/2017/05/28/Pythonic-Distance-Conversion.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "My Universe",
    "author": {
        "@type": "Person",
        "name": "Jesco Freund",
        "image": "https://avatars2.githubusercontent.com/u/461745?v=3",
        "url": "https://daemotron.github.io/author/daemotron/",
        "sameAs": "http://www.my-universe.com"
    },
    "headline": "Pythonic Distance Conversion",
    "url": "https://daemotron.github.io/2017/05/28/Pythonic-Distance-Conversion.html",
    "datePublished": "2017-05-28T00:00:00.000Z",
    "keywords": "Development, Python",
    "description": "When dealing with distances or lengths, it&amp;#8217;s a common problem to convert values between all the different units available out there. Of course, converting itself is a less than complicated simple floating point division or multiplication, depending on how values and conversion factors are stored internally. However, maintaining"
}
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="My Universe" href="https://daemotron.github.io/rss/" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/styles/atom-one-dark.min.css">
  </head>
  <body class="post-template tag-Development tag-Python">
    <header id="menu-button" class="expanded">
      <a><i class="icon icon-list"></i></a>
    </header>
    <aside class="cover" style="background: url() center/cover no-repeat fixed">
      <div class="cover container">
        <div class="profile">
    
          <hr class="divider long" />
          <p>Mens Insana In Corpore Ignavo</p>
          <hr class="divider short" />
          <div class="navigation">
            <div class="profile contact">
              
              <nav class="navigation right">
                <ul class="social expanded">
              
              
              
              
                  <!-- Github -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://github.com/daemotron" title="Github account">
                      <i class='icon icon-social-github'></i>
                      <span class="label">Github</span>
                    </a>
                  </li>
                  </li>
              
              
              
              
                  <!-- LinkedIn -->
                  <li class="social item hvr-grow-rotate">
                    <a rel="me" href="https://www.linkedin.com/in/jescofreund" title="LinkedIn account">
                      <i class='icon icon-social-linkedin'></i>
                      <span class="label">LinkedIn</span>
                    </a>
                  </li>
              
              
                </ul>
              </nav>
              <!-- <section class="icon icon-search" id="search-container">
      <hr class="divider short" />
      <form id="search-form">
        <input type="text", name="search", placeholder="git, css, javascript,..." id="search-field" />
      </form>
    </section>
     -->
            </div>
          </div>
        </div>
      </div>
    </aside>
    <main>
      <section id="search-results"></section>
      <section class="content">
        

  <article class="post tag-Development tag-Python">
    <header>
      <div class="post meta">
        <time datetime="28 May 2017">28 May 2017</time>
        <span class="post tags">in <a href="https://daemotron.github.io/tag/Development/">Development</a> <a href="https://daemotron.github.io/tag/Python/">Python</a></span>


        <span class="post reading-time"> ~ <span></span> read.</span>
      </div>
      <a alt="Tweet 'Pythonic Distance Conversion'" href="https://twitter.com/intent/tweet?text=Pythonic%20Distance%20Conversion%20%C2%BB&amp;hashtags=Development,Python&amp;url=https://daemotron.github.io/2017/05/28/Pythonic-Distance-Conversion.html">
        
        <h1 class="icon-reverse icon-social-twitter-post" id="post-title">Pythonic Distance Conversion</h1>
      </a>
    </header>

    <div id="post-content" class="post tag-Development tag-Python">
      <div class="paragraph">
<p>When dealing with distances or lengths, it&#8217;s a common problem to convert values between all the different units
available out there. Of course, converting itself is a less than complicated simple floating point division or
multiplication, depending on how values and conversion factors are stored internally. However, maintaining conversion
factors all accross a project is a tedious task, and Python has some good means at hand to simplify our life.</p>
</div>
<div class="paragraph">
<p>Before entering into implementation details, let&#8217;s have a look at some general rules that make life easier when dealing
with distances or lengths (or any other unit of measurement). First, it&#8217;s a good idea to align on one single reference
unit. All values will be stored in this unit, and all computations are done using this unit. Any other unit will be
treated as input/output filter. Second, it&#8217;s also a very good idea to use
<a href="https://en.wikipedia.org/wiki/International_System_of_Units">SI units</a> for that purpose. No, that&#8217;s not another rant
about why the metric system is superior to the imperial system, but SI units generally have well-defined conversions
to any other unit system. Example: common imperial units such as <em>inch</em>, <em>foot</em>, <em>yard</em> and <em>mile</em> have a standard
definition based on the SI unit <em>metre</em> (broad hint: use <em>metre</em> as base unit when doing length calculations).</p>
</div>
<div class="paragraph">
<p>Finally, when dealing with conversion, it would be nice (and very pythonic) to not have the poor guy implementing stuff
on your API call <code>convert</code> routines for any operation. Instead, providing result objects offering the result in any
conversion available is a much nicer way of implementing API-transparent conversion.</p>
</div>
<div class="paragraph">
<p>A basic class representing a distance could look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">class Distance(object):

    def __init__(self, value=0.0):
        self._distance = float(value)

    @property
    def raw(self):
        return self._distance

    @raw.setter
    def raw(self, value):
        self._distance = float(value)</code></pre>
</div>
</div>
<div class="paragraph">
<p>All very fine, but right now, this class is not yet an improvement: its objects cannot be used in arithmetic
expressions, and there&#8217;s no conversion between units either. On top of that, its representation in a shell is as
speaking as <code>&lt;Distance object at 0x108479f60&gt;</code>. Not very impressive, I know&#8201;&#8212;&#8201;but let&#8217;s fix those issues one by one.</p>
</div>
<div class="paragraph">
<p>First, we want a decent representation making it easier to play with the class in an interactive Python interpreter.
That can be achieved by adding a
<a href="https://docs.python.org/3/reference/datamodel.html#object.__repr__"><code>__repr__</code> method</a>.
In our case this can be as simple as this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def __repr__(self):
    return str(self._distance)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The next fundamental problem we want to fix: trying to cast a <code>Distance</code> object into a numeric data type will raise
a <a href="https://docs.python.org/3/library/exceptions.html#TypeError">TypeError</a> exception. This can be easily fixed by adding
<a href="https://docs.python.org/3/reference/datamodel.html#object.__int__">cast methods</a> to our class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def __float__(self):
    return self._distance

def __int__(self):
    return int(self._distance)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we know we can cast a <code>Distance</code> object into a float value, we can tackle the problem of arithmetic expressions.
To avoid too much lengthy code right here, I will just demonstrate this for the addition. Python allows us to implement
arithmetic operations in way that allow even mixing <code>Distance</code> objects with other numeric objects (i. e. integers or
floating point numbers) or any other object as long as it can be cast into a floating point number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def __add__(self, other):
    return Distance(self._dist + float(other))

def __radd__(self, other):
    return Distance(self._dist + float(other))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Implementing both methods,
<a href="https://docs.python.org/3/reference/datamodel.html#object.__add__"><code>__add__</code></a> and
<a href="https://docs.python.org/3/reference/datamodel.html#object.__radd__"><code>__radd__</code></a> is necessary to ensure
addition works also with non-<code>Distance</code> operands being put in the first place. This
<a href="https://stackoverflow.com/questions/24431288/understanding-arithmetic-operators-in-python#24431474">post on
StackOverflow</a> by <a href="https://stackoverflow.com/users/100297/martijn-pieters">Martijn Pieters</a> offers a good explanation of
the How and Why.</p>
</div>
<div class="paragraph">
<p>Implementing rich comparison operators (&lt;, &gt;, ==, &#8656;, &gt;=) works along the same lines, just that there are no explicit
reflected implementations (instead, the opposite operator is used as reflected implementation, e. g. &lt; is the reflected
operator to &gt;=, and == pairs with !=). I will not waste time and space here to replicate what&#8217;s already written in the
<a href="https://docs.python.org/3/reference/datamodel.html#object.__lt__">Python documentation</a> on that subject.</p>
</div>
<div class="paragraph">
<p>Wait, so far we managed to produce a class that more or less does the same as any trivial float? Indeed, you&#8217;re right
about that, but there was a requirement about converting distances into different units, wasn&#8217;t it? That would really
set our class apart from what a standard float value could do.</p>
</div>
<div class="paragraph">
<p>Now, the first thing any programmer would consider is adding properties to the class, managing the conversion of units.
Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">@property
def in_yards(self):
    return self._distance / 0.9144

@in_yards.setter
def in_yards(self, value):
    self._distance = float(value) * 0.9144</code></pre>
</div>
</div>
<div class="paragraph">
<p>This way, <code>in_yards</code> becomes a writeable property that automatically converts back and forth, so the internal
representation remains in metres. Pretty cool, eh? But to my reckoning, this is ugly to maintain:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>You need a getter and setter method for each conversion you want to offer, which bloats your code</p>
</li>
<li>
<p>Having numeric constants scattered all across the code is a no-no as well</p>
</li>
<li>
<p>This approach hurts the DRY paradigm ("don&#8217;t repeat yourself")</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>From a code maintenance and transparency point of view, it would be much better to centrally maintain a list of
units and their conversion rules, and have our <code>Distance</code> class learn them dynamically. Fostering a modular design,
we keep the list of units and the conversion itself well out of our <code>Distance</code> class (so you could use them in
any other class as well).</p>
</div>
<div class="paragraph">
<p><strong>The following code goes <em>outside</em> of the <code>Distance</code> class definition!</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">import math

factors = {
    'mm': 0.001,
    'cm': 0.01,
    'in': 0.0254,
    'dm': 0.1,
    'ft': 0.3048,
    'yd': 0.9144,
    'm':  1.0,
    'km': 1000.0,
    'mi': 1609.344,
    'nm': 1852.0,
    'gm': 1855.3248,
    'ls': 299792458.0,
    'au': 149597870700.0,
    'ly': 9460730472580800.0,
    'pc': (648000.0 / math.pi) * 149597870700.0,
}

available = set(factors.keys())

def convert(value, from_unit, to_unit):
    assert {from_unit, to_unit} &lt;= available
    return value * factors[from_unit] / factors[to_unit]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Yes, that&#8217;s the way the <a href="https://en.wikipedia.org/wiki/International_Astronomical_Union">IAU</a> defines one
<a href="https://en.wikipedia.org/wiki/Parsec">parsec</a>&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>I put all that in a separate module, hence I set the <code>available</code> reference for convenience when using the module
from outside. I consciously chose a set over tuple or list, as it permits checking for subsets (i. e. it is possible
to test multiple units in one statement, as demonstrated in the <code>convert</code> implementation).</p>
</div>
<div class="paragraph">
<p>Now coming back to the <code>Distance</code> class. As already shown before, properties would make a nice way to have conversion
implemented. This would allow to get and set the distance value in any unit, probably looking like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">&gt;&gt;&gt; d = Distance(100)
&gt;&gt;&gt; d.in_ft
328.0839895013123
&gt;&gt;&gt; d.in_yd = 200
&gt;&gt;&gt; d
182.88</code></pre>
</div>
</div>
<div class="paragraph">
<p>To spare us the pain of maintaining a gazillion property getter and setter methods for this purpose, we can abuse the
fact that in Python it&#8217;s quite easy to hack around the implementation of new-style classes. Thus, we just have to
implement a custom method adding properties to the class at runtime:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">def __set(self, value, unit):
    self._distance = convert(value, unit, 'm')

def __add_property(self, name, value, doc=None):
    setattr(
        self.__class__, 'in_' + name, property(
            fget=lambda self: convert(self._distance, 'm', 'name'),
            fset=lambda self, value: self.__set(value, name),
            doc=doc
        )
    )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since assignments are not allowed in <code>lambda</code> statements, I use an auxiliary <code>__set()</code> method which does the
conversion and assigns the result to the internal instance variable representating the distance value.</p>
</div>
<div class="paragraph">
<p>Finally, <code>__init__</code> needs to actually create all the properties. This can be done in a simple loop:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-python" data-lang="python">_distance = 0.0

def __init__(self, value=0.0, unit='m'):
    self.__set(value, unit)
    for i in available:
        self.__add_property(i, convert(value, unit, i))</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since <code>__init__</code> does no longer explicitly define <code>_distance</code>, it&#8217;s good style to set <code>_distance</code> as
instance variable already at class level. Otherwise you will get warnings from different lint tools.</p>
</div>
<div class="paragraph">
<p>That&#8217;s it already&#8201;&#8212;&#8201;with those elements, a <code>Distance</code> class fulfils all our requirements set at the beginning:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>its instances behave (almost) like regular numeric data types (float, int)</p>
</li>
<li>
<p>an instance&#8217;s value can be easily retrieved in any unit conversion</p>
</li>
<li>
<p>conversions are easy to maintain (Python dictionary)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The full implementation with all the bells and whistles is available as
<a href="https://gist.github.com/daemotron/aa100f65c6db0ed5c7064a6954ceaa28">GitHub Gist</a> (note how most of the code is actually
dedicated to giving the class a predictable "numeric" behaviour).</p>
</div>
    </div>

    <div class="post related">

    </div>

    <footer class="post comments">
        <div id="disqus_thread"></div>
        <script type="text/javascript">
        var disqus_shortname = 'daemotron'; // required: replace example with your forum shortname
        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </footer>

  </article>


        <footer>
          <span class="copyright">
            &copy; 2017. All rights reserved. Built with <a href="https://github.com/Kikobeats/uno-zen" target="_blank">Uno Zen</a> under <a href="http://hubpress.io/" target="_blank">HubPress</a>.
          </span>
        </footer>
      </section>
    </main>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.10.0/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>
       
    <script src='https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML'></script>
    <script src="//daemotron.github.io/themes/uno-zen/assets/js/uno-zen.js?v=1495998380823" type="text/javascript" charset="utf-8"></script>
  </body>
</html>
